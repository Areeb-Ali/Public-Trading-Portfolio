<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Portfolio</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner look and feel, and font import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Custom scrollbar styling for a sleeker appearance */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #2d3748;
        }
        /* Page content styling */
        .page-content {
            display: none;
        }
        .page-content.active {
            display: block;
        }
        /* Dark mode colors */
        .dark body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-gray-100 {
            background-color: #2d3748;
        }
        .dark .bg-white {
            background-color: #1f2937;
        }
        .dark .bg-gray-200 {
            background-color: #2a3340;
        }
        .dark .text-gray-900 {
            color: #e2e8f0;
        }
        .dark .border-gray-300 {
            border-color: #4a5568;
        }
        .dark .hover\:bg-gray-100:hover {
            background-color: #2a3340;
        }
        /* TradingView widget container */
        .tradingview-widget-container {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-lg sticky top-0 z-50 rounded-b-xl">
        <nav class="container mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between">
            <a href="#" class="text-xl font-bold text-indigo-600 mb-4 md:mb-0">TradeVision</a>
            <div class="space-x-4 md:space-x-8 text-sm font-medium">
                <a href="#home" class="hover:text-indigo-600 transition duration-300" onclick="showPage('home')">Home</a>
                <a href="#about" class="hover:text-indigo-600 transition duration-300" onclick="showPage('about')">About</a>
                <a href="#portfolio" class="hover:text-indigo-600 transition duration-300" onclick="showPage('portfolio')">Portfolio</a>
                <a href="#performance" class="hover:text-indigo-600 transition duration-300" onclick="showPage('performance')">Performance</a>
                <a href="#analysis" class="hover:text-indigo-600 transition duration-300" onclick="showPage('analysis')">Analysis</a>
                <a href="#services" class="hover:text-indigo-600 transition duration-300" onclick="showPage('services')">Services</a>
                <a href="#contact" class="hover:text-indigo-600 transition duration-300" onclick="showPage('contact')">Contact</a>
            </div>
            <button id="darkModeToggle" class="mt-4 md:mt-0 px-4 py-2 bg-gray-200 rounded-full text-sm font-semibold hover:bg-gray-300 transition duration-300">
                ‚òÄÔ∏è
            </button>
        </nav>
    </header>

    <!-- Main Content Container -->
    <main class="container mx-auto px-4 py-8">

        <!-- Home Page -->
        <section id="home" class="page-content active space-y-12">
            <div class="text-center py-16 bg-white rounded-2xl shadow-lg">
                <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 mb-4 leading-tight">Your Vision, Our Strategy.</h1>
                <p class="text-lg md:text-xl text-gray-600 mb-8 max-w-2xl mx-auto">Mastering the markets, one trade at a time.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <div class="p-6 bg-gray-100 rounded-xl shadow-md text-center">
                        <h3 class="text-3xl font-bold text-green-500 mb-2" id="winRate">0%</h3>
                        <p class="text-gray-600">Win Rate</p>
                    </div>
                    <div class="p-6 bg-gray-100 rounded-xl shadow-md text-center">
                        <h3 class="text-3xl font-bold text-yellow-500 mb-2" id="accuracy">0%</h3>
                        <p class="text-gray-600">Accuracy</p>
                    </div>
                    <div class="p-6 bg-gray-100 rounded-xl shadow-md text-center">
                        <h3 class="text-3xl font-bold text-blue-500 mb-2" id="totalTrades">0</h3>
                        <p class="text-gray-600">Total Trades</p>
                    </div>
                </div>
            </div>

            <!-- Live Price Ticker Section -->
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-900">Live Market Data</h2>
                <div id="priceTicker" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Price cards will be dynamically inserted here -->
                </div>
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-900">Featured Charts</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="tradingview-widget-container rounded-xl overflow-hidden shadow-lg">
                            <div class="tradingview-widget-container__widget"></div>
                            <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">TradingView</span></a></div>
                        </div>
                        <div class="tradingview-widget-container rounded-xl overflow-hidden shadow-lg">
                            <div class="tradingview-widget-container__widget"></div>
                            <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">TradingView</span></a></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testimonials Section -->
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-900">What Our Clients Say</h2>
                <div id="testimonialsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Testimonial cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Newsletter Signup Section -->
            <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Join Our Newsletter</h2>
                <p class="text-gray-600 mb-6">Receive exclusive analysis and updates directly to your inbox.</p>
                <form id="newsletterForm" class="max-w-md mx-auto flex flex-col sm:flex-row gap-4">
                    <input type="email" id="newsletterEmail" placeholder="Enter your email" required class="flex-grow p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition duration-300">Subscribe</button>
                </form>
            </div>
        </section>

        <!-- About Page -->
        <section id="about" class="page-content space-y-8">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-4 text-gray-900">About the Trader</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="w-full md:w-auto">
                        <img src="https://placehold.co/400x400/2d3748/ffffff?text=Trader+Photo" alt="Trader Profile" class="rounded-xl shadow-lg w-full">
                    </div>
                    <div class="space-y-4 text-gray-600">
                        <p>I'm a passionate and analytical trader with over a decade of experience in the financial markets. My journey began with a deep fascination for market psychology and quantitative analysis, leading me to pursue a degree in Financial Engineering.</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Education:</strong> B.S. in Financial Engineering, M.S. in Quantitative Finance.</li>
                            <li><strong>Certifications:</strong> Chartered Financial Analyst (CFA) Level III, Certified Technical Analyst (CTA).</li>
                            <li><strong>Trading Philosophy:</strong> I believe in a disciplined, data-driven approach. My strategy combines a top-down macroeconomic perspective with precise technical analysis to identify high-probability setups across various asset classes. Risk management is the cornerstone of my trading, ensuring capital preservation and sustainable growth.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Portfolio / Setups Page -->
        <section id="portfolio" class="page-content space-y-8">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Trade Setups</h2>
                <div class="flex flex-col md:flex-row gap-4 mb-8">
                    <select id="portfolioFilterCoin" class="p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="all">All Coins</option>
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                        <option value="XAU">Gold (XAU)</option>
                    </select>
                    <input type="date" id="portfolioFilterDate" class="p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <select id="portfolioFilterResult" class="p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="all">All Results</option>
                        <option value="Win">Win</option>
                        <option value="Loss">Loss</option>
                        <option value="Breakeven">Breakeven</option>
                    </select>
                </div>
                <div id="setupsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Trade setup cards will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <!-- Performance / Accuracy Page -->
        <section id="performance" class="page-content space-y-8">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Performance Metrics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                    <div class="p-6 bg-gray-100 rounded-xl shadow-md">
                        <h3 class="text-3xl font-bold text-green-500 mb-2" id="winLossRatio">0:0</h3>
                        <p class="text-gray-600">Win/Loss Ratio</p>
                    </div>
                    <div class="p-6 bg-gray-100 rounded-xl shadow-md">
                        <h3 class="text-3xl font-bold text-yellow-500 mb-2" id="accuracyPerformance">0%</h3>
                        <p class="text-gray-600">Accuracy %</p>
                    </div>
                    <div class="p-6 bg-gray-100 rounded-xl shadow-md">
                        <h3 class="text-3xl font-bold text-blue-500 mb-2" id="totalTradesPerformance">0</h3>
                        <p class="text-gray-600">Total Trades</p>
                    </div>
                    <div class="p-6 bg-gray-100 rounded-xl shadow-md">
                        <h3 class="text-3xl font-bold text-purple-500 mb-2" id="avgGainLoss">+0%</h3>
                        <p class="text-gray-600">Avg Gain/Loss</p>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4 text-gray-900">Monthly Performance</h3>
                    <div id="monthlyStatsContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-6">
                        <!-- Monthly stats will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Economic & Market Analysis Section -->
        <section id="analysis" class="page-content space-y-8">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Market Analysis</h2>
                <div id="analysisContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Analysis posts will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <!-- Services Page -->
        <section id="services" class="page-content space-y-8">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Our Services</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Account Management Card -->
                    <div class="bg-gray-100 p-6 rounded-xl shadow-md hover:shadow-lg transition duration-300">
                        <h3 class="text-2xl font-bold mb-2 text-indigo-600">Account Management</h3>
                        <p class="text-gray-600 mb-4">Let our experts handle your trading account with a proven strategy and strict risk management.</p>
                        <p class="text-sm text-gray-500">Terms & Conditions apply. Performance is not guaranteed. Past results are not indicative of future performance.</p>
                    </div>
                    <!-- Copy Trading Card -->
                    <div class="bg-gray-100 p-6 rounded-xl shadow-md hover:shadow-lg transition duration-300">
                        <h3 class="text-2xl font-bold mb-2 text-indigo-600">Copy Trading</h3>
                        <p class="text-gray-600 mb-4">Automatically replicate our trades in your own brokerage account. Seamless and secure.</p>
                    </div>
                    <!-- Mentorship Program Card -->
                    <div class="bg-gray-100 p-6 rounded-xl shadow-md hover:shadow-lg transition duration-300">
                        <h3 class="text-2xl font-bold mb-2 text-indigo-600">Mentorship Program</h3>
                        <p class="text-gray-600 mb-4">Learn to trade like a professional. Our mentorship program provides one-on-one guidance and comprehensive training.</p>
                    </div>
                </div>
            </div>
            <!-- Affiliate Links Section -->
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Recommended Brokers</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <a href="#" class="flex items-center justify-center p-4 bg-gray-100 rounded-xl shadow-md hover:bg-gray-200 transition duration-300">
                        <span class="text-xl font-bold text-gray-600">Broker A</span>
                    </a>
                    <a href="#" class="flex items-center justify-center p-4 bg-gray-100 rounded-xl shadow-md hover:bg-gray-200 transition duration-300">
                        <span class="text-xl font-bold text-gray-600">Broker B</span>
                    </a>
                    <a href="#" class="flex items-center justify-center p-4 bg-gray-100 rounded-xl shadow-md hover:bg-gray-200 transition duration-300">
                        <span class="text-xl font-bold text-gray-600">Broker C</span>
                    </a>
                    <a href="#" class="flex items-center justify-center p-4 bg-gray-100 rounded-xl shadow-md hover:bg-gray-200 transition duration-300">
                        <span class="text-xl font-bold text-gray-600">Broker D</span>
                    </a>
                </div>
            </div>
        </section>

        <!-- Contact Page -->
        <section id="contact" class="page-content space-y-8">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-gray-900">Get in Touch</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Contact Form -->
                    <div>
                        <form id="contactForm" class="space-y-4">
                            <div>
                                <label for="contactName" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="contactName" required class="mt-1 p-3 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="contactEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="contactEmail" required class="mt-1 p-3 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="contactMessage" class="block text-sm font-medium text-gray-700">Message</label>
                                <textarea id="contactMessage" rows="4" required class="mt-1 p-3 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition duration-300">Send Message</button>
                        </form>
                    </div>
                    <!-- Social Buttons -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-gray-900">Or Connect via:</h3>
                        <a href="#" class="w-full flex items-center justify-center py-3 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition duration-300">
                            <span class="mr-2">üìû</span>WhatsApp
                        </a>
                        <a href="#" class="w-full flex items-center justify-center py-3 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 transition duration-300">
                            <span class="mr-2">‚úàÔ∏è</span>Telegram
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Disclaimer & Footer -->
    <footer class="bg-white py-8 mt-12 rounded-t-xl shadow-lg">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500 space-y-4">
            <p class="font-bold text-red-600">Disclaimer</p>
            <p>Risk Warning: Trading financial instruments carries a high level of risk and may not be suitable for all investors. The content on this website is for informational purposes only and does not constitute financial advice. Past performance is not indicative of future results.</p>
            <p>&copy; 2024 TradeVision. All Rights Reserved.</p>
            <p class="text-xs">User ID: <span id="userIdDisplay">Loading...</span></p>
        </div>
    </footer>

    <!-- TradingView Widget Scripts -->
    <script src="https://s3.tradingview.com/external-embedding/embed-widget-mini-chart.js" async></script>
    <script>
        new TradingView.widget(
            {
            "width": "100%",
            "height": "100%",
            "symbol": "BITSTAMP:BTCUSD",
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "2",
            "locale": "en",
            "enable_publishing": false,
            "backgroundColor": "#1a202c",
            "chartOnly": true
            }
        );
        new TradingView.widget(
            {
            "width": "100%",
            "height": "100%",
            "symbol": "FX_IDC:XAUUSD",
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "2",
            "locale": "en",
            "enable_publishing": false,
            "backgroundColor": "#1a202c",
            "chartOnly": true
            }
        );
    </script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase imports from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let userId;

        // Function to safely initialize Firebase
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialized successfully.");

                    // Listen for authentication state changes
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("User is signed in with UID:", userId);
                            document.getElementById('userIdDisplay').textContent = userId;
                            
                            // Once authenticated, fetch data
                            await Promise.all([
                                fetchPerformanceData(),
                                fetchTradeSetups(),
                                fetchMarketAnalysis(),
                                fetchTestimonials()
                            ]);
                        } else {
                            console.log("User is signed out.");
                            // Sign in anonymously if no auth token is provided or after sign-out
                            if (!initialAuthToken) {
                                await signInAnonymously(auth);
                            }
                        }
                    });

                    // Sign in with the custom token if available
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        // Or sign in anonymously as a fallback
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }

                } else {
                    console.error("Firebase config is missing. Firestore operations will not work.");
                    // Set mock user ID if Firebase isn't available
                    userId = 'mock-user-' + Math.random().toString(36).substr(2, 9);
                    document.getElementById('userIdDisplay').textContent = userId + ' (Mock)';
                    // Fetch mock data instead
                    fetchMockData();
                }
            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                // Set mock user ID on error
                userId = 'mock-user-' + Math.random().toString(36).substr(2, 9);
                document.getElementById('userIdDisplay').textContent = userId + ' (Mock)';
                fetchMockData();
            }
        }

        // --- Data Fetching and Display Functions ---

        // Fetches and displays performance data from Firestore
        async function fetchPerformanceData() {
            if (!db || !userId) return;
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/performance/`, "summary");
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('winRate').textContent = `${(data.winRate * 100).toFixed(0)}%`;
                        document.getElementById('accuracy').textContent = `${(data.accuracy * 100).toFixed(0)}%`;
                        document.getElementById('totalTrades').textContent = data.totalTrades;
                        document.getElementById('winLossRatio').textContent = `${data.wins}:${data.losses}`;
                        document.getElementById('accuracyPerformance').textContent = `${(data.accuracy * 100).toFixed(0)}%`;
                        document.getElementById('totalTradesPerformance').textContent = data.totalTrades;
                        document.getElementById('avgGainLoss').textContent = `${data.avgGainLoss > 0 ? '+' : ''}${(data.avgGainLoss * 100).toFixed(2)}%`;

                        const monthlyContainer = document.getElementById('monthlyStatsContainer');
                        monthlyContainer.innerHTML = '';
                        // Sort months to ensure correct display order
                        const sortedMonths = Object.keys(data.monthlyStats).sort();
                        sortedMonths.forEach(month => {
                            const monthData = data.monthlyStats[month];
                            const card = `
                                <div class="p-4 bg-gray-100 rounded-xl shadow-md text-center">
                                    <h4 class="text-lg font-semibold text-gray-800">${month}</h4>
                                    <p class="text-sm text-gray-600">Trades: ${monthData.totalTrades}</p>
                                    <p class="text-sm font-bold ${monthData.netGainLoss > 0 ? 'text-green-500' : 'text-red-500'}">${(monthData.netGainLoss * 100).toFixed(2)}%</p>
                                </div>
                            `;
                            monthlyContainer.innerHTML += card;
                        });
                    }
                }, (error) => {
                    console.error("Error fetching performance data:", error);
                });
            } catch (error) {
                console.error("Error setting up performance data listener:", error);
            }
        }

        // Fetches and displays trade setups from Firestore
        async function fetchTradeSetups() {
            if (!db || !userId) return;
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/setups/`));
                onSnapshot(q, (querySnapshot) => {
                    const setups = [];
                    querySnapshot.forEach((doc) => {
                        setups.push({ id: doc.id, ...doc.data() });
                    });
                    renderTradeSetups(setups);
                }, (error) => {
                    console.error("Error fetching trade setups:", error);
                });
            } catch (error) {
                console.error("Error setting up trade setups listener:", error);
            }
        }

        // Fetches and displays market analysis posts from Firestore
        async function fetchMarketAnalysis() {
            if (!db || !userId) return;
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/analysis/`));
                onSnapshot(q, (querySnapshot) => {
                    const posts = [];
                    querySnapshot.forEach((doc) => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    renderMarketAnalysis(posts);
                }, (error) => {
                    console.error("Error fetching market analysis:", error);
                });
            } catch (error) {
                console.error("Error setting up market analysis listener:", error);
            }
        }

        // Fetches and displays testimonials from Firestore
        async function fetchTestimonials() {
            if (!db || !userId) return;
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/testimonials/`));
                onSnapshot(q, (querySnapshot) => {
                    const testimonials = [];
                    querySnapshot.forEach((doc) => {
                        testimonials.push({ id: doc.id, ...doc.data() });
                    });
                    renderTestimonials(testimonials);
                }, (error) => {
                    console.error("Error fetching testimonials:", error);
                });
            } catch (error) {
                console.error("Error setting up testimonials listener:", error);
            }
        }

        // --- Data Rendering Functions ---

        function renderTradeSetups(setups) {
            const container = document.getElementById('setupsContainer');
            container.innerHTML = ''; // Clear previous content
            setups.forEach(setup => {
                const resultColor = setup.result === 'Win' ? 'bg-green-500' : setup.result === 'Loss' ? 'bg-red-500' : 'bg-gray-500';
                const card = `
                    <div class="bg-gray-100 p-6 rounded-xl shadow-md">
                        <img src="${setup.chartUrl}" alt="Trade Chart" class="rounded-lg mb-4">
                        <h4 class="text-xl font-semibold mb-2 text-gray-900">${setup.asset} - ${setup.date}</h4>
                        <div class="flex items-center mb-4">
                            <span class="px-3 py-1 text-xs font-bold text-white rounded-full ${resultColor}">${setup.result}</span>
                        </div>
                        <p class="text-gray-600"><strong>Entry:</strong> ${setup.entry}</p>
                        <p class="text-gray-600"><strong>TP:</strong> ${setup.tp}</p>
                        <p class="text-gray-600"><strong>SL:</strong> ${setup.sl}</p>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function renderMarketAnalysis(posts) {
            const container = document.getElementById('analysisContainer');
            container.innerHTML = '';
            posts.forEach(post => {
                const card = `
                    <div class="bg-gray-100 p-6 rounded-xl shadow-md">
                        <h4 class="text-xl font-bold mb-2 text-gray-900">${post.title}</h4>
                        <p class="text-sm text-gray-500 mb-4">${post.date}</p>
                        <p class="text-gray-600">${post.summary}</p>
                        <button class="mt-4 text-indigo-600 font-semibold hover:text-indigo-700">Read More</button>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function renderTestimonials(testimonials) {
            const container = document.getElementById('testimonialsContainer');
            container.innerHTML = '';
            testimonials.forEach(testimonial => {
                const card = `
                    <div class="bg-gray-100 p-6 rounded-xl shadow-md space-y-4">
                        <p class="text-gray-600 italic">"${testimonial.message}"</p>
                        <p class="font-semibold text-right text-gray-800">- ${testimonial.author}</p>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // --- Mock Data Functions (if Firebase is not available) ---
        function fetchMockData() {
            console.log("Using mock data as Firebase config is not available.");
            // Mock Performance Data
            const mockPerformance = {
                winRate: 0.75,
                accuracy: 0.82,
                totalTrades: 125,
                wins: 94,
                losses: 31,
                avgGainLoss: 0.15,
                monthlyStats: {
                    'Jan 2024': { totalTrades: 20, netGainLoss: 0.15 },
                    'Feb 2024': { totalTrades: 18, netGainLoss: 0.12 },
                    'Mar 2024': { totalTrades: 25, netGainLoss: 0.21 },
                    'Apr 2024': { totalTrades: 30, netGainLoss: 0.25 },
                    'May 2024': { totalTrades: 15, netGainLoss: 0.08 },
                    'Jun 2024': { totalTrades: 17, netGainLoss: 0.18 }
                }
            };
            // Mock a listener-like behavior
            setTimeout(() => {
                document.getElementById('winRate').textContent = `${(mockPerformance.winRate * 100).toFixed(0)}%`;
                document.getElementById('accuracy').textContent = `${(mockPerformance.accuracy * 100).toFixed(0)}%`;
                document.getElementById('totalTrades').textContent = mockPerformance.totalTrades;
                document.getElementById('winLossRatio').textContent = `${mockPerformance.wins}:${mockPerformance.losses}`;
                document.getElementById('accuracyPerformance').textContent = `${(mockPerformance.accuracy * 100).toFixed(0)}%`;
                document.getElementById('totalTradesPerformance').textContent = mockPerformance.totalTrades;
                document.getElementById('avgGainLoss').textContent = `${mockPerformance.avgGainLoss > 0 ? '+' : ''}${(mockPerformance.avgGainLoss * 100).toFixed(2)}%`;
                const monthlyContainer = document.getElementById('monthlyStatsContainer');
                monthlyContainer.innerHTML = '';
                const sortedMonths = Object.keys(mockPerformance.monthlyStats).sort();
                sortedMonths.forEach(month => {
                    const monthData = mockPerformance.monthlyStats[month];
                    const card = `
                        <div class="p-4 bg-gray-100 rounded-xl shadow-md text-center">
                            <h4 class="text-lg font-semibold text-gray-800">${month}</h4>
                            <p class="text-sm text-gray-600">Trades: ${monthData.totalTrades}</p>
                            <p class="text-sm font-bold ${monthData.netGainLoss > 0 ? 'text-green-500' : 'text-red-500'}">${(monthData.netGainLoss * 100).toFixed(2)}%</p>
                        </div>
                    `;
                    monthlyContainer.innerHTML += card;
                });
            }, 1000);

            // Mock Trade Setups
            const mockSetups = [
                { id: '1', asset: 'BTC', date: '2024-05-20', chartUrl: 'https://placehold.co/400x250/333/fff?text=BTC+Trade', entry: '65,000', tp: '68,500', sl: '64,000', result: 'Win' },
                { id: '2', asset: 'ETH', date: '2024-05-18', chartUrl: 'https://placehold.co/400x250/333/fff?text=ETH+Trade', entry: '3,000', tp: '3,100', sl: '2,950', result: 'Loss' },
                { id: '3', asset: 'XAU', date: '2024-05-15', chartUrl: 'https://placehold.co/400x250/333/fff?text=Gold+Trade', entry: '2,350', tp: '2,400', sl: '2,345', result: 'Win' }
            ];
            renderTradeSetups(mockSetups);

            // Mock Market Analysis
            const mockAnalysis = [
                { id: '1', title: 'CPI Report Impact on Markets', date: '2024-06-12', summary: 'The recent CPI data suggests a slowing down of inflation, potentially leading to a more dovish stance from the Fed. This could be bullish for risk assets.' },
                { id: '2', title: 'FOMC Meeting Summary', date: '2024-06-05', summary: 'The Fed held rates steady, but their forward guidance indicates a data-dependent approach. Market participants are now pricing in potential rate cuts later this year.' }
            ];
            renderMarketAnalysis(mockAnalysis);

            // Mock Testimonials
            const mockTestimonials = [
                { id: '1', author: 'Jane Doe', message: 'The analysis provided is top-notch. I\'ve significantly improved my trading results by following the insights.' },
                { id: '2', author: 'John Smith', message: 'Professional and transparent. The mentorship program was a game-changer for me. Highly recommended!' }
            ];
            renderTestimonials(mockTestimonials);
        }

        // --- Form Submission Handlers ---

        // Handle contact form submission
        document.getElementById('contactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('contactName').value;
            const email = document.getElementById('contactEmail').value;
            const message = document.getElementById('contactMessage').value;

            if (!db || !userId) {
                console.error("Firebase not initialized. Cannot submit form.");
                alert("Form submission failed. Firebase is not configured correctly.");
                return;
            }

            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/contacts/`), {
                    name: name,
                    email: email,
                    message: message,
                    timestamp: new Date()
                });
                alert("Message sent successfully!");
                e.target.reset();
            } catch (error) {
                console.error("Error writing document:", error);
                alert("Error sending message. Please try again.");
            }
        });

        // Handle newsletter form submission
        document.getElementById('newsletterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('newsletterEmail').value;

            if (!db || !userId) {
                console.error("Firebase not initialized. Cannot submit form.");
                alert("Subscription failed. Firebase is not configured correctly.");
                return;
            }

            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/newsletter/`), {
                    email: email,
                    timestamp: new Date()
                });
                alert("Thank you for subscribing!");
                e.target.reset();
            } catch (error) {
                console.error("Error writing document:", error);
                alert("Error subscribing. Please try again.");
            }
        });


        // --- UI Logic and Event Listeners ---

        // Show/hide page content based on navigation
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // Dark mode toggle functionality
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('darkModeToggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            // Re-render TradingView widgets to match theme. A full reload is the easiest way.
            location.reload();
        });

        // Set initial theme based on localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.documentElement.classList.remove('dark');
            document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
        }

        // Fetch and display live price tickers (mock data)
        function fetchLivePrices() {
            const prices = {
                'BTC/USD': (Math.random() * 1000 + 60000).toFixed(2),
                'ETH/USD': (Math.random() * 50 + 3000).toFixed(2),
                'XAU/USD': (Math.random() * 10 + 2300).toFixed(2),
                'S&P 500': (Math.random() * 20 + 5200).toFixed(2),
            };

            const priceTickerContainer = document.getElementById('priceTicker');
            priceTickerContainer.innerHTML = ''; // Clear previous content

            for (const [symbol, price] of Object.entries(prices)) {
                const isPositive = Math.random() > 0.5;
                const change = (Math.random() * 0.5 + 0.1).toFixed(2);
                const changeColor = isPositive ? 'text-green-500' : 'text-red-500';
                const changeSign = isPositive ? '+' : '-';

                const card = `
                    <div class="p-4 bg-gray-100 rounded-xl shadow-md">
                        <h4 class="text-lg font-bold text-gray-800 mb-1">${symbol}</h4>
                        <p class="text-2xl font-bold">${price}</p>
                        <p class="${changeColor} text-sm">${changeSign}${change}%</p>
                    </div>
                `;
                priceTickerContainer.innerHTML += card;
            }
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            showPage('home'); // Show the home page by default
            fetchLivePrices();
            setInterval(fetchLivePrices, 10000); // Update prices every 10 seconds
        });
    </script>
</body>
</html>
